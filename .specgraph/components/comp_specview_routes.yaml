# Component Definition: SpecView Routes
# Implements: feat_specview_dashboard_core, feat_specview_hierarchy_view, feat_specview_design_view, feat_specview_relation_view
# Validated against sub_meta_schema.yaml

id: comp_specview_routes
type: module
desc: "FastAPI 路由处理器，实现各视图的 API 端点和页面渲染。"
file_path: "devspec/specview/routes/"

tech_stack:
  - fastapi
  - jinja2
  - htmx  # 前端无需 JS 框架，使用 htmx 实现动态交互

dependencies:
  - comp_graph_database  # For querying nodes
  - comp_graph_query  # For graph queries
  - comp_specview_templates  # For template rendering
  - comp_specview_graph_renderer  # For Mermaid graph generation

# === 详细设计 (Design) ===
design:
  api:
    # Home 路由
    - signature: "home_router: APIRouter"
      desc: "首页路由，渲染导航指南和产品概览"
      methods:
        - signature: "async def home(request: Request) -> HTMLResponse"
          desc: "渲染首页 home.html"
          returns:
            type: "HTMLResponse"
            desc: "渲染后的 HTML 页面"

    # Hierarchy 路由
    - signature: "hierarchy_router: APIRouter"
      desc: "层级结构视图路由"
      methods:
        - signature: "async def hierarchy_view(request: Request) -> HTMLResponse"
          desc: "渲染层级结构主页"
        - signature: "async def get_domain_children(domain_id: str) -> HTMLResponse"
          desc: "htmx 端点：获取 Domain 下的 Features (懒加载)"
        - signature: "async def get_feature_children(feature_id: str) -> HTMLResponse"
          desc: "htmx 端点：获取 Feature 下的 Components (懒加载)"
        - signature: "async def node_detail(node_type: str, node_id: str) -> HTMLResponse"
          desc: "渲染节点详情页 (带 Breadcrumb)"

    # Design 路由
    - signature: "design_router: APIRouter"
      desc: "设计知识视图路由"
      methods:
        - signature: "async def design_view(request: Request) -> HTMLResponse"
          desc: "渲染 Design/Substrate 列表页 (带知识类型指引)"
        - signature: "async def design_detail(design_id: str) -> HTMLResponse"
          desc: "渲染 Design 节点详情"
        - signature: "async def substrate_detail(substrate_id: str) -> HTMLResponse"
          desc: "渲染 Substrate 节点详情"

    # Relation 路由
    - signature: "relation_router: APIRouter"
      desc: "依赖关系视图路由"
      methods:
        - signature: "async def relation_view(node_id: str) -> HTMLResponse"
          desc: "渲染节点的依赖关系页面 (含 Mermaid 图)"
        - signature: "async def get_relation_graph(node_id: str, depth: int = 2) -> HTMLResponse"
          desc: "htmx 端点：获取 Mermaid 依赖图 SVG"

  logic: |
    # Home Router
    1. home():
       1.1 调用 get_navigation_guide() 获取导航指南
       1.2 调用 graph_database.get_product() 获取产品概览
       1.3 渲染 home.html，传入 nav_guide, product

    # Hierarchy Router
    2. hierarchy_view():
       2.1 调用 graph_database.get_all_domains() 获取 Domain 列表
       2.2 渲染 hierarchy.html，传入 domains (折叠状态)

    3. get_domain_children(domain_id):
       3.1 调用 graph_database.get_features_by_domain(domain_id)
       3.2 渲染 partials/feature_list.html (htmx partial)

    4. get_feature_children(feature_id):
       4.1 调用 graph_database.get_components_by_feature(feature_id)
       4.2 渲染 partials/component_list.html (htmx partial)

    5. node_detail(node_type, node_id):
       5.1 根据 node_type 查询节点详情
       5.2 构建 Breadcrumb: Product > Domain > Feature > Component
       5.3 如果是 Component，准备可折叠的 sections:
           - Summary (always visible)
           - Tech Stack (collapsed)
           - API Signatures (expanded)
           - Logic (collapsed)
           - Constants (collapsed)
       5.4 渲染 node_detail.html，传入 node, breadcrumb, sections

    # Design Router
    6. design_view():
       6.1 调用 graph_database.get_all_designs() 和 get_all_substrates()
       6.2 准备知识类型指引数据 (KNOWLEDGE_TYPE_GUIDE)
       6.3 渲染 design.html，传入 designs, substrates, guide

    7. design_detail(design_id):
       7.1 调用 graph_database.get_design(design_id)
       7.2 解析 rationale, principles 等字段
       7.3 渲染 design_detail.html

    # Relation Router
    8. relation_view(node_id):
       8.1 调用 graph_database.get_node_relations(node_id)
       8.2 分组为 depends_on, depended_by, realized_by, realizes
       8.3 调用 graph_renderer.generate_mermaid(node_id, relations)
       8.4 渲染 relation.html，传入 relations, mermaid_svg

    9. get_relation_graph(node_id, depth):
       9.1 调用 graph_renderer.generate_mermaid(node_id, depth)
       9.2 返回 SVG 内容 (htmx 替换目标区域)

  constants:
    KNOWLEDGE_TYPE_GUIDE: |
      [
        {
          "type": "Design (des_*)",
          "icon": "lightbulb",
          "color": "blue",
          "question": "为什么这样设计？",
          "when_to_read": "当你想理解决策背后的原因时",
          "typical_content": ["设计原则", "架构决策", "权衡取舍"]
        },
        {
          "type": "Substrate (sub_*)",
          "icon": "ruler",
          "color": "green",
          "question": "怎么执行？有什么约束？",
          "when_to_read": "当你要写代码或创建文件时",
          "typical_content": ["格式规范", "命名约定", "验证规则"]
        }
      ]
