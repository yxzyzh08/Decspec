# Component Definition: SpecView Search Engine
# Implements: feat_specview_search
# Validated against sub_meta_schema.yaml

id: comp_specview_search_engine
type: module
desc: "全文搜索引擎，提供节点搜索和结果高亮功能。"
file_path: "devspec/specview/"

tech_stack:
  - sqlite3  # 使用 SQLite FTS5 全文搜索

dependencies:
  - comp_graph_database  # For accessing node data

# === 详细设计 (Design) ===
design:
  api:
    - signature: "class SearchEngine"
      desc: "SpecGraph 搜索引擎类"
      methods:
        - signature: "def __init__(self, db: GraphDatabase)"
          desc: "初始化搜索引擎，注入数据库依赖，确保 FTS5 索引存在"
          params:
            - name: "db"
              type: "GraphDatabase"
              desc: "SpecGraph 数据库实例"

        - signature: "def ensure_fts_index(self) -> None"
          desc: "确保 FTS5 全文索引存在并更新"
          params: []
          returns:
            type: "None"
            desc: "无返回值，索引不存在则创建"

        - signature: "def rebuild_fts_index(self) -> None"
          desc: "重建 FTS5 索引 (数据同步后调用)"
          params: []
          returns:
            type: "None"
            desc: "无返回值"

        - signature: "def search_nodes(query: str, type_filter: Optional[str] = None) -> SearchResult"
          desc: "搜索节点，支持 ID、名称、内容匹配"
          params:
            - name: "query"
              type: "str"
              desc: "搜索关键词"
            - name: "type_filter"
              type: "Optional[str]"
              desc: "类型过滤器 (feature, component, design, substrate)"
          returns:
            type: "SearchResult"
            desc: "搜索结果，包含匹配节点和上下文片段"

        - signature: "def get_search_suggestions(prefix: str) -> List[str]"
          desc: "获取搜索建议 (自动补全)"
          params:
            - name: "prefix"
              type: "str"
              desc: "输入前缀"
          returns:
            type: "List[str]"
            desc: "匹配的节点 ID 列表"

    - signature: "@dataclass class SearchResult"
      desc: "搜索结果数据结构"
      fields:
        - name: "query"
          type: "str"
          desc: "原始搜索词"
        - name: "total_count"
          type: "int"
          desc: "匹配总数"
        - name: "items"
          type: "List[SearchResultItem]"
          desc: "结果项列表"
        - name: "suggestions"
          type: "List[SearchSuggestion]"
          desc: "无结果时的建议列表"

    - signature: "@dataclass class SearchResultItem"
      desc: "单个搜索结果项"
      fields:
        - name: "node_id"
          type: "str"
          desc: "节点 ID"
        - name: "node_type"
          type: "str"
          desc: "节点类型"
        - name: "title"
          type: "str"
          desc: "节点标题/名称"
        - name: "snippet"
          type: "str"
          desc: "匹配的上下文片段 (带高亮)"
        - name: "score"
          type: "float"
          desc: "相关性得分"
        - name: "url"
          type: "str"
          desc: "节点详情页 URL"

    - signature: "@dataclass class SearchSuggestion"
      desc: "搜索建议"
      fields:
        - name: "text"
          type: "str"
          desc: "建议文本"
        - name: "action"
          type: "str"
          desc: "建议动作 (try_shorter, try_prefix, link_to_hierarchy)"

  logic: |
    0. __init__(self, db):
       0.1 保存数据库引用: self.db = db
       0.2 调用 ensure_fts_index() 确保索引存在

    0.5 ensure_fts_index():
        0.5.1 检查 FTS5 虚拟表是否存在:
              SELECT name FROM sqlite_master WHERE type='table' AND name='nodes_fts'
        0.5.2 如果不存在，创建 FTS5 虚拟表:
              CREATE VIRTUAL TABLE nodes_fts USING fts5(
                node_id,
                node_type,
                name,
                content,
                content='nodes',
                content_rowid='rowid'
              )
        0.5.3 如果表存在但为空，触发重建:
              SELECT COUNT(*) FROM nodes_fts
              如果 count == 0: rebuild_fts_index()

    0.6 rebuild_fts_index():
        0.6.1 清空现有索引: DELETE FROM nodes_fts
        0.6.2 从 nodes 表填充索引:
              INSERT INTO nodes_fts(node_id, node_type, name, content)
              SELECT id, type, name,
                     COALESCE(intent, '') || ' ' || COALESCE(desc, '') || ' ' || COALESCE(content, '')
              FROM nodes
        0.6.3 优化索引: INSERT INTO nodes_fts(nodes_fts) VALUES('optimize')

    1. search_nodes(query, type_filter):
       1.1 验证查询: 如果 len(query) < 2，返回空结果 + "请输入至少2个字符" 提示
       1.2 检测查询类型:
           - is_id_prefix = query.startswith(('feat_', 'comp_', 'des_', 'sub_', 'dom_'))
       1.3 构建搜索策略:
           if is_id_prefix:
               # ID 前缀匹配优先
               sql = "SELECT * FROM nodes WHERE id LIKE ? ORDER BY id"
               results = db.execute(sql, [f"{query}%"])
           else:
               # FTS5 全文搜索
               sql = """
                   SELECT n.*, bm25(nodes_fts) as score
                   FROM nodes_fts
                   JOIN nodes n ON nodes_fts.node_id = n.id
                   WHERE nodes_fts MATCH ?
                   ORDER BY score
                   LIMIT 50
               """
               # 转换查询为 FTS5 语法 (空格分隔的词用 OR 连接)
               fts_query = ' OR '.join(query.split())
               results = db.execute(sql, [fts_query])
           if type_filter:
               results = [r for r in results if r.type == type_filter]
       1.4 为每个结果生成 snippet:
           for node in results:
               snippet = extract_snippet(node.content, query, context_chars=50)
               snippet = highlight_keywords(snippet, query)
       1.5 如果结果为空，生成建议:
           suggestions = generate_empty_state_suggestions(query)
       1.6 返回 SearchResult(query, len(results), items, suggestions)

    2. extract_snippet(content, query, context_chars):
       2.1 找到 query 在 content 中的位置
       2.2 提取前后 context_chars 个字符
       2.3 在边界处添加 "..." 省略号
       2.4 返回片段

    3. highlight_keywords(text, query):
       3.1 将 query 拆分为关键词
       3.2 用 <mark> 标签包裹匹配的关键词
       3.3 返回高亮后的文本

    4. generate_empty_state_suggestions(query):
       4.1 返回预定义的建议列表:
           - "尝试更短的关键词" (try_shorter)
           - "尝试搜索 ID 前缀: feat_, comp_, des_, sub_" (try_prefix)
           - "浏览层级结构找到目标" (link_to_hierarchy, url=/hierarchy)

    5. get_search_suggestions(prefix):
       5.1 查询所有节点 ID 以 prefix 开头的节点
       5.2 限制返回数量 (最多 10 个)
       5.3 按相关性排序

  constants:
    MIN_QUERY_LENGTH: 2
    MAX_SUGGESTIONS: 10
    SNIPPET_CONTEXT_CHARS: 50
    MAX_SEARCH_RESULTS: 50

    # FTS5 虚拟表创建 SQL
    FTS5_CREATE_SQL: |
      CREATE VIRTUAL TABLE IF NOT EXISTS nodes_fts USING fts5(
        node_id,
        node_type,
        name,
        content,
        tokenize='unicode61'
      )

    # FTS5 索引重建 SQL
    FTS5_REBUILD_SQL: |
      INSERT INTO nodes_fts(node_id, node_type, name, content)
      SELECT id, type, name,
             COALESCE(intent, '') || ' ' || COALESCE(desc, '') || ' ' || COALESCE(content, '')
      FROM nodes

    # FTS5 全文搜索 SQL (带 BM25 排序)
    FTS5_SEARCH_SQL: |
      SELECT n.*, bm25(nodes_fts) as score
      FROM nodes_fts
      JOIN nodes n ON nodes_fts.node_id = n.id
      WHERE nodes_fts MATCH ?
      ORDER BY score
      LIMIT ?

    EMPTY_STATE_SUGGESTIONS: |
      [
        {
          "text": "尝试更短的关键词",
          "example": "搜索 'core' 而非 'core engine module'",
          "action": "try_shorter"
        },
        {
          "text": "尝试搜索 ID 前缀",
          "example": "feat_, comp_, dom_, des_, sub_",
          "action": "try_prefix"
        },
        {
          "text": "浏览层级结构找到目标",
          "action": "link_to_hierarchy",
          "url": "/hierarchy"
        }
      ]

    SEARCH_HINTS: |
      {
        "empty_input": "输入关键词开始搜索，支持 ID、名称、描述",
        "single_char": "请输入至少 2 个字符",
        "id_prefix": "检测到 ID 前缀，将优先匹配节点 ID"
      }

  error_handling:
    - condition: "查询太短 (< 2 字符)"
      action: "返回空结果，提示 '请输入至少2个字符'"
    - condition: "数据库查询失败"
      action: "捕获异常，返回 loading_error 状态和恢复建议"
    - condition: "无匹配结果"
      action: "返回 no_results 状态，附带搜索建议"
