# Component Definition: SpecView Templates
# Implements: feat_specview_dashboard_core, feat_specview_hierarchy_view, feat_specview_design_view
# Validated against sub_meta_schema.yaml

id: comp_specview_templates
type: module
desc: "Jinja2 æ¨¡æ¿å¼•æ“é…ç½®å’ŒåŸºç¡€æ¨¡æ¿æ–‡ä»¶ï¼Œå®ç° SpecGraph Viewer çš„é¡µé¢æ¸²æŸ“ã€‚"
file_path: "templates/"

tech_stack:
  - jinja2
  - tailwindcss  # CDN å¼•å…¥ï¼Œæ— éœ€æ„å»º
  - htmx  # CDN å¼•å…¥ï¼Œå®ç°æ—  JS åŠ¨æ€äº¤äº’

dependencies: []

# === è¯¦ç»†è®¾è®¡ (Design) ===
design:
  api:
    - signature: "def get_templates() -> Jinja2Templates"
      desc: "è·å–é…ç½®å¥½çš„ Jinja2Templates å®ä¾‹"
      params: []
      returns:
        type: "Jinja2Templates"
        desc: "æŒ‡å‘ templates/ ç›®å½•çš„æ¨¡æ¿å®ä¾‹"

  logic: |
    æ¨¡æ¿æ–‡ä»¶ç»“æ„:
    templates/
    â”œâ”€â”€ base.html           # åŸºç¡€å¸ƒå±€ (Header, Footer, å…¨å±€æ ·å¼)
    â”œâ”€â”€ home.html           # é¦–é¡µ (å¯¼èˆªæŒ‡å—ã€äº§å“æ¦‚è§ˆ)
    â”œâ”€â”€ hierarchy.html      # å±‚çº§ç»“æ„è§†å›¾
    â”œâ”€â”€ design.html         # è®¾è®¡çŸ¥è¯†è§†å›¾
    â”œâ”€â”€ relation.html       # ä¾èµ–å…³ç³»è§†å›¾
    â”œâ”€â”€ search.html         # æœç´¢è§†å›¾
    â”œâ”€â”€ node_detail.html    # é€šç”¨èŠ‚ç‚¹è¯¦æƒ…é¡µ
    â”œâ”€â”€ components/         # ç»„ä»¶åº“ (éµå¾ª Spec-First åŸåˆ™)
    â”‚   â”œâ”€â”€ _index.yaml     # ç»„ä»¶ç´¢å¼•
    â”‚   â”œâ”€â”€ cards/          # å¡ç‰‡ç±»ç»„ä»¶
    â”‚   â”œâ”€â”€ nav/            # å¯¼èˆªç±»ç»„ä»¶
    â”‚   â””â”€â”€ badges/         # å¾½ç« ç±»ç»„ä»¶
    â””â”€â”€ partials/           # htmx å±€éƒ¨æ¨¡æ¿
        â”œâ”€â”€ feature_list.html
        â”œâ”€â”€ component_list.html
        â”œâ”€â”€ relation_graph.html
        â””â”€â”€ search_results.html

    1. base.html åŸºç¡€å¸ƒå±€è®¾è®¡:
       1.1 <head>: å¼•å…¥ Tailwind CSS CDN, htmx CDN
       1.2 <header>: Logo, å¯¼èˆªé“¾æ¥ (Home, Hierarchy, Design, Relations), æœç´¢æ¡†
       1.3 <nav id="breadcrumb">: Breadcrumb å¯¼èˆªåŒºåŸŸ (Spatial Consistency)
       1.4 <main>: å†…å®¹åŒºåŸŸ {% block content %}{% endblock %}
       1.5 <footer>: ç‰ˆæƒä¿¡æ¯

    2. home.html é¦–é¡µè®¾è®¡:
       2.1 äº§å“æ¦‚è§ˆå¡ç‰‡ (åç§°, ç‰ˆæœ¬, æè¿°, Vision)
       2.2 å¯¼èˆªæŒ‡å—åŒºåŸŸ (4 ä¸ªè§†å›¾çš„å¼•å¯¼å¡ç‰‡):
           - æ¯ä¸ªå¡ç‰‡åŒ…å« icon, title, purpose, best_for
           - ä½¿ç”¨ Tailwind grid å¸ƒå±€ (2x2)
       2.3 å¿«é€Ÿå…¥å£: "å¼€å§‹æµè§ˆ" æŒ‰é’®æŒ‡å‘ Hierarchy View

    3. hierarchy.html å±‚çº§è§†å›¾è®¾è®¡:
       3.1 æ ‘å½¢ç»“æ„å®¹å™¨ï¼Œä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§
       3.2 æ¯ä¸ª Domain/Feature æœ‰å±•å¼€/æŠ˜å æŒ‰é’®
       3.3 htmx æ‡’åŠ è½½: hx-get="/hierarchy/domain/{id}/children" hx-trigger="click"
       3.4 ä½¿ç”¨ Tailwind çš„ border-l å®ç°å±‚çº§è¿çº¿

    4. node_detail.html èŠ‚ç‚¹è¯¦æƒ…è®¾è®¡:
       4.1 Breadcrumb å¯¼èˆª (Product > Domain > Feature > Component)
       4.2 èŠ‚ç‚¹åŸºç¡€ä¿¡æ¯ (ID, Name, Desc)
       4.3 å¯æŠ˜å åˆ†åŒº (ä½¿ç”¨ <details> åŸç”Ÿ HTML5):
           - <details open> é»˜è®¤å±•å¼€
           - <details> é»˜è®¤æŠ˜å 
       4.4 å…³ç³»é“¾æ¥åŒºåŸŸ (depends_on, realized_by åˆ—è¡¨)

    5. htmx äº¤äº’æ¨¡å¼:
       5.1 æ‡’åŠ è½½: hx-get, hx-trigger="click"
       5.2 æœç´¢: hx-get="/search?q=...", hx-trigger="keyup changed delay:300ms"
       5.3 éƒ¨åˆ†æ›¿æ¢: hx-target="#result-container", hx-swap="innerHTML"

  # æ¨¡æ¿ä»£ç ç‰‡æ®µ - æé«˜ä»£ç å¯è¿˜åŸæ€§
  templates_detail:
    # å±‚çº§è§†å›¾æ ‘èŠ‚ç‚¹ (å¯å¤ç”¨æ¨¡å¼)
    hierarchy_tree_item: |
      {# Domain å±‚çº§èŠ‚ç‚¹ #}
      <div class="pl-4 border-l-2 border-gray-300 hover:border-blue-500 transition-colors">
        <button hx-get="/hierarchy/domain/{{ domain.id }}/children"
                hx-target="#children-{{ domain.id }}"
                hx-trigger="click once"
                hx-swap="innerHTML"
                class="flex items-center w-full text-left py-2 hover:bg-gray-50">
          <span class="expand-icon mr-2 transition-transform">â–¶</span>
          <span class="font-medium">{{ domain.name }}</span>
          <span class="ml-2 text-sm text-gray-500">({{ domain.feature_count }} features)</span>
        </button>
        <div id="children-{{ domain.id }}" class="pl-4"></div>
      </div>

    # Feature åˆ—è¡¨é¡¹ (htmx partial)
    feature_list_item: |
      {# partials/feature_list.html #}
      {% for feature in features %}
      <div class="pl-4 border-l-2 border-blue-300 py-1">
        <a href="/node/feature/{{ feature.id }}"
           class="flex items-center hover:text-blue-600">
          <span class="text-blue-500 mr-2">â—†</span>
          <span>{{ feature.name or feature.id }}</span>
        </a>
        <button hx-get="/hierarchy/feature/{{ feature.id }}/children"
                hx-target="#comp-{{ feature.id }}"
                hx-trigger="click once"
                class="text-xs text-gray-400 hover:text-gray-600 ml-6">
          å±•å¼€ç»„ä»¶
        </button>
        <div id="comp-{{ feature.id }}" class="pl-4"></div>
      </div>
      {% endfor %}

    # èŠ‚ç‚¹è¯¦æƒ…å¯æŠ˜å åˆ†åŒº
    collapsible_section: |
      {# node_detail.html ä¸­çš„å¯æŠ˜å åˆ†åŒº #}
      <details {% if section.default_state == 'expanded' %}open{% endif %} class="mb-4">
        <summary class="cursor-pointer bg-gray-100 px-4 py-2 rounded-t font-medium hover:bg-gray-200">
          {{ section.title }}
        </summary>
        <div class="border border-t-0 border-gray-200 px-4 py-3 rounded-b">
          {% block section_content %}{% endblock %}
        </div>
      </details>

    # API ç­¾åå±•ç¤º
    api_signature_display: |
      {# Component è¯¦æƒ…çš„ API å±•ç¤º #}
      <div class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm overflow-x-auto">
        {% for api in component.design.api %}
        <div class="mb-2">
          <span class="text-blue-400">def</span> {{ api.signature }}
          {% if api.desc %}
          <span class="text-gray-500 ml-4"># {{ api.desc }}</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>

    # æœç´¢ç»“æœé¡¹ (å¸¦é«˜äº®)
    search_result_item: |
      {# partials/search_results.html #}
      {% for item in results.items %}
      <a href="{{ item.url }}" class="block p-4 border-b hover:bg-gray-50">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 text-xs rounded
            {% if item.node_type == 'feature' %}bg-blue-100 text-blue-700
            {% elif item.node_type == 'component' %}bg-green-100 text-green-700
            {% else %}bg-gray-100 text-gray-700{% endif %}">
            {{ item.node_type }}
          </span>
          <span class="font-medium">{{ item.title }}</span>
        </div>
        <p class="text-sm text-gray-600 mt-1">{{ item.snippet | safe }}</p>
      </a>
      {% else %}
      {# ç©ºçŠ¶æ€ #}
      <div class="text-center py-8">
        <div class="text-4xl mb-4">ğŸ”</div>
        <p class="text-gray-600">{{ results.suggestions[0].text }}</p>
        <a href="/hierarchy" class="text-blue-600 hover:underline mt-2 inline-block">
          æµè§ˆå±‚çº§ç»“æ„
        </a>
      </div>
      {% endfor %}

    # Breadcrumb å¯¼èˆª
    breadcrumb_nav: |
      {# å…¨å±€ Breadcrumbï¼Œåœ¨ base.html ä¸­ #}
      <nav id="breadcrumb" class="bg-gray-100 px-4 py-2 text-sm">
        <ol class="flex items-center gap-2">
          <li><a href="/" class="text-blue-600 hover:underline">DevSpec</a></li>
          {% for crumb in breadcrumbs %}
          <li class="flex items-center gap-2">
            <span class="text-gray-400">/</span>
            {% if crumb.url %}
            <a href="{{ crumb.url }}" class="text-blue-600 hover:underline">{{ crumb.name }}</a>
            {% else %}
            <span class="text-gray-700">{{ crumb.name }}</span>
            {% endif %}
          </li>
          {% endfor %}
        </ol>
      </nav>

  constants:
    BASE_TEMPLATE_HEAD: |
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}SpecGraph Viewer{% endblock %}</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/htmx.org@1.9.10"></script>
        <style>
          /* è‡ªå®šä¹‰æ ·å¼ */
          .node-feature { border-left-color: #3B82F6; }
          .node-component { border-left-color: #10B981; }
          .node-design { border-left-color: #8B5CF6; }
        </style>
      </head>

    HEADER_TEMPLATE: |
      <header class="bg-gray-800 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
          <a href="/" class="text-xl font-bold">DevSpec</a>
          <nav class="flex gap-6">
            <a href="/" class="hover:text-blue-300">Home</a>
            <a href="/hierarchy" class="hover:text-blue-300">Hierarchy</a>
            <a href="/design" class="hover:text-blue-300">Design</a>
            <a href="/relation" class="hover:text-blue-300">Relations</a>
          </nav>
          <form hx-get="/search" hx-target="#main-content" hx-trigger="submit">
            <input type="search" name="q" placeholder="æœç´¢èŠ‚ç‚¹..." class="px-3 py-1 rounded text-black">
          </form>
        </div>
      </header>

  output_files:
    - path: "templates/base.html"
      format: "Jinja2 base template with {% block %} placeholders"
    - path: "templates/home.html"
      format: "Jinja2 template extending base.html"
    - path: "templates/partials/*.html"
      format: "Jinja2 partial templates for htmx responses"
