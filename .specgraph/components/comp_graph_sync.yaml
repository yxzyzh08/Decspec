# Component Definition: Graph Sync
# Implements: feat_specgraph_database

id: comp_graph_sync
type: module
desc: "YAML to database synchronization engine with incremental updates and change detection."
file_path: "devspec/core/graph_sync.py"

tech_stack:
  - "PyYAML"
  - "hashlib"

dependencies:
  - comp_graph_database  # For database operations
  - comp_spec_indexer    # For YAML file discovery

design:
  api:
    - signature: "class GraphSync"
      desc: "Synchronization engine for YAML to database sync"
      methods:
        - signature: "__init__(self, db: GraphDatabase, root_path: Path) -> None"
          desc: "Initialize sync engine with database and project root."
          params:
            - name: "db"
              type: "GraphDatabase"
              desc: "Database instance"
            - name: "root_path"
              type: "Path"
              desc: "Project root path"

        - signature: "sync_all(self) -> SyncResult"
          desc: "Full sync of all YAML files to database."
          returns:
            type: "SyncResult"
            desc: "Sync statistics (added, updated, deleted counts)"

        - signature: "sync_file(self, file_path: Path) -> SyncResult"
          desc: "Sync a single YAML file to database."
          params:
            - name: "file_path"
              type: "Path"
              desc: "Path to YAML file"
          returns:
            type: "SyncResult"
            desc: "Sync result for this file"

        - signature: "detect_changes(self) -> ChangeSet"
          desc: "Detect which files have changed since last sync."
          returns:
            type: "ChangeSet"
            desc: "Lists of added, modified, deleted files"

        - signature: "sync_incremental(self) -> SyncResult"
          desc: "Sync only changed files (incremental sync)."
          returns:
            type: "SyncResult"
            desc: "Sync statistics"

    - signature: "class SyncResult"
      desc: "Result of sync operation"
      fields:
        - name: "added"
          type: "int"
          desc: "Number of nodes added"
        - name: "updated"
          type: "int"
          desc: "Number of nodes updated"
        - name: "deleted"
          type: "int"
          desc: "Number of nodes deleted"
        - name: "edges_created"
          type: "int"
          desc: "Number of edges created"
        - name: "errors"
          type: "List[str]"
          desc: "List of error messages"

    - signature: "class ChangeSet"
      desc: "Set of detected changes"
      fields:
        - name: "added"
          type: "List[Path]"
          desc: "New YAML files"
        - name: "modified"
          type: "List[Path]"
          desc: "Modified YAML files"
        - name: "deleted"
          type: "List[str]"
          desc: "Node IDs whose files were deleted"

  logic: |
    1. sync_all():
       1.1 获取所有 YAML 文件: spec_dir.rglob("*.yaml")
       1.2 过滤 .runtime 目录
       1.3 对每个文件调用 _sync_yaml_file()
       1.4 同步 product.yaml 中的虚拟 Domain 节点
       1.5 构建并同步所有边关系
       1.6 删除数据库中存在但 YAML 已删除的节点
       1.7 返回 SyncResult

    2. _sync_yaml_file(file_path):
       2.1 读取 YAML 内容
       2.2 计算 content_hash: hashlib.sha256(content.encode()).hexdigest()
       2.3 查询数据库中的 content_hash
       2.4 如果 hash 相同，跳过 (无变化)
       2.5 如果 hash 不同或不存在:
           2.5.1 解析 YAML 为 dict
           2.5.2 提取必要字段构建 NodeModel
           2.5.3 调用 db.upsert_node()
       2.6 返回 (is_new, is_updated)

    3. _build_edges(nodes_dict):
       3.1 遍历所有节点
       3.2 Product -> Domain: 从 product.domains 提取 contains 边
       3.3 Domain -> Feature: 从 domain.features 提取 owns 边
       3.4 Feature -> Feature: 从 feature.depends_on 提取 depends_on 边
       3.5 Feature -> Component: 从 feature.realized_by 提取 realized_by 边
       3.6 Component -> Component: 从 component.dependencies 提取 depends_on 边
       3.7 Domain -> DomainAPI: 从 domain.exports 提取 exports 边

    4. detect_changes():
       4.1 获取数据库中所有节点的 (id, source_file, content_hash)
       4.2 扫描文件系统中所有 YAML 文件
       4.3 对比:
           - 文件存在但 DB 无记录 -> added
           - 文件存在且 hash 不同 -> modified
           - DB 有记录但文件不存在 -> deleted
       4.4 返回 ChangeSet

    5. sync_incremental():
       5.1 调用 detect_changes() 获取 ChangeSet
       5.2 只处理 added 和 modified 文件
       5.3 删除 deleted 节点
       5.4 返回 SyncResult

  constants:
    SKIP_DIRS:
      - ".runtime"
      - "__pycache__"
    VALID_NODE_TYPES:
      - "product"
      - "domain"
      - "feature"
      - "component"
      - "design"
      - "substrate"

  error_handling:
    - condition: "Invalid YAML syntax"
      action: "Log error with file path, skip file, add to errors list"
    - condition: "Missing required field (id)"
      action: "Log warning, skip file, add to errors list"
    - condition: "Reference to non-existent node (e.g., depends_on unknown feature)"
      action: "Log warning, skip edge creation, continue processing"
