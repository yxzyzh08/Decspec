# Component Definition: Graph Sync
# Implements: feat_specgraph_database

id: comp_graph_sync
type: module
desc: "YAML to database full synchronization engine."
file_path: "devspec/core/graph_sync.py"

tech_stack:
  - "PyYAML"

dependencies:
  - comp_graph_database  # For database operations
  - comp_spec_indexer    # For YAML file discovery

design:
  api:
    - signature: "class GraphSync"
      desc: "Synchronization engine for YAML to database sync"
      methods:
        - signature: "__init__(self, db: GraphDatabase, root_path: Path) -> None"
          desc: "Initialize sync engine with database and project root."
          params:
            - name: "db"
              type: "GraphDatabase"
              desc: "Database instance"
            - name: "root_path"
              type: "Path"
              desc: "Project root path"

        - signature: "sync_all(self) -> SyncResult"
          desc: "Full sync of all YAML files to database."
          returns:
            type: "SyncResult"
            desc: "Sync statistics (added, updated, deleted counts)"

        - signature: "sync_file(self, file_path: Path) -> SyncResult"
          desc: "Sync a single YAML file to database."
          params:
            - name: "file_path"
              type: "Path"
              desc: "Path to YAML file"
          returns:
            type: "SyncResult"
            desc: "Sync result for this file"

    - signature: "class SyncResult"
      desc: "Result of sync operation"
      fields:
        - name: "added"
          type: "int"
          desc: "Number of nodes added"
        - name: "updated"
          type: "int"
          desc: "Number of nodes updated"
        - name: "deleted"
          type: "int"
          desc: "Number of nodes deleted"
        - name: "edges_created"
          type: "int"
          desc: "Number of edges created"
        - name: "errors"
          type: "List[str]"
          desc: "List of error messages"

  logic: |
    1. sync_all():
       1.1 清空数据库中所有节点和边
       1.2 获取所有 YAML 文件: spec_dir.rglob("*.yaml")
       1.3 过滤 .runtime 目录
       1.4 对每个文件调用 _sync_yaml_file()
       1.5 提取 product.yaml 中的虚拟 Domain 节点 (_extract_domain_nodes)
       1.6 构建并同步所有边关系 (_build_and_sync_edges)
       1.7 返回 SyncResult

    2. _sync_yaml_file(file_path):
       2.1 读取 YAML 内容
       2.2 解析 YAML 为 dict
       2.3 提取必要字段构建 NodeModel
       2.4 调用 db.upsert_node()
       2.5 返回 node_data

    3. _extract_domain_nodes(product_path):
       3.1 读取 product.yaml
       3.2 遍历 domains 列表
       3.3 为每个 domain 创建虚拟节点，包含:
           - id, type, name, description
           - exports 字段 (关键: 必须保留以便后续同步 domain_apis)
           - _is_virtual 标记
       3.4 返回 domain_nodes 列表

    4. _build_and_sync_edges(nodes_dict):
       4.1 遍历所有节点
       4.2 Product -> Domain: 从 product.domains 提取 contains 边
       4.3 Domain -> Feature: 从 feature.domain 字段反向建立 owns 边
       4.4 Feature -> Feature: 从 feature.depends_on 提取 depends_on 边
       4.5 Feature -> Component: 从 feature.realized_by 提取 realized_by 边
       4.6 Component -> Component: 从 component.dependencies 提取 depends_on 边
       4.7 Domain -> DomainAPI: 从 domain.exports 提取 API 并插入 domain_apis 表

  constants:
    SKIP_DIRS:
      - ".runtime"
      - "__pycache__"
    VALID_NODE_TYPES:
      - "product"
      - "domain"
      - "feature"
      - "component"
      - "design"
      - "substrate"

  error_handling:
    - condition: "Invalid YAML syntax"
      action: "Log error with file path, skip file, add to errors list"
    - condition: "Missing required field (id)"
      action: "Log warning, skip file, add to errors list"
    - condition: "Reference to non-existent node (e.g., depends_on unknown feature)"
      action: "Log warning, skip edge creation, continue processing"
