# Component Definition: Requirement Analyzer
# Part of feat_requirement_collector
# Validated against sub_meta_schema.yaml

id: comp_req_analyzer
type: module
desc: "负责检查需求是否符合 Product Vision，并按粒度分解任务 (Domain/Feature/Component)。"
file_path: "devspec/core/req_collector/analyzer.py"

tech_stack:
  - pydantic
  - openai (or llm_interface)

dependencies:
  - comp_spec_indexer

# === 详细设计 (Design) ===
design:
  api:
    - signature: "def analyze_requirement(content: str) -> AnalysisResult"
      desc: "Analyze alignment and decompose tasks"
      params:
        - name: "content"
          type: "str"
          desc: "Raw user input"
      returns:
        type: "AnalysisResult"
        desc: "Structured analysis result including vision check and task list"

  logic: |
    1. Load Product Vision from `PRD.md` (via SpecIndexer)
    2. Load Design Principles from `des_architecture.yaml` (Granularity, User Value Test)
    3. Call LLM to check alignment:
       - If not aligned: Return result with `aligned=False` and reason.
    4. If aligned, call LLM to decompose tasks using Principles:
       - Apply **User Value Test**: Can user accept it?
       - Apply **Granularity Rules**:
         - **L0 (Domain)**: Strategic Scope (Cross-functional).
         - **L1 (Feature)**: User Value Unit (Independent Acceptance).
         - **L2 (Component)**: Detailed Design (1:1 File Mapping).
       - Identify affected Domains/Features/Components based on these rules.
    5. Return structured `AnalysisResult`

  data_models:
    - name: "AnalysisResult"
      fields:
        - aligned: bool
        - reason: str
        - tasks: List[TaskItem]
